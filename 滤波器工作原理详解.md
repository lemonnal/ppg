# PPGä¿¡å·å¤„ç†ç³»ç»Ÿ - æ»¤æ³¢å™¨å·¥ä½œåŸç†è¯¦è§£

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®ç»“æ„åˆ†æ](#é¡¹ç›®ç»“æ„åˆ†æ)
2. [æ»¤æ³¢å™¨ç±»å‹ä¸é…ç½®](#æ»¤æ³¢å™¨ç±»å‹ä¸é…ç½®)
3. [DSPFiltersåº“å†…éƒ¨è°ƒç”¨é“¾è·¯](#dspfiltersåº“å†…éƒ¨è°ƒç”¨é“¾è·¯)
4. [æ•°å­¦åŸç†è¯¦è§£](#æ•°å­¦åŸç†è¯¦è§£)
5. [å†…å­˜å¸ƒå±€ä¸çŠ¶æ€ç®¡ç†](#å†…å­˜å¸ƒå±€ä¸çŠ¶æ€ç®¡ç†)
6. [å®æ—¶å¤„ç†æµç¨‹](#å®æ—¶å¤„ç†æµç¨‹)
7. [æ€§èƒ½åˆ†æ](#æ€§èƒ½åˆ†æ)
8. [å…³é”®è®¾è®¡ç‰¹ç‚¹](#å…³é”®è®¾è®¡ç‰¹ç‚¹)
9. [å®Œæ•´è°ƒç”¨æ ˆ](#å®Œæ•´è°ƒç”¨æ ˆ)

---

## é¡¹ç›®ç»“æ„åˆ†æ

### æ ¸å¿ƒæ–‡ä»¶

**ä¸»ç¨‹åºï¼š**
- `realtime_main.cpp` - å®æ—¶PPGä¿¡å·å¤„ç†ä¸»ç¨‹åºï¼Œæ¨¡æ‹ŸåµŒå…¥å¼å®æ—¶ç³»ç»Ÿ

**æ»¤æ³¢å™¨å®ç°ï¼š**
- `include/realtime_filter.hpp` + `src/realtime_filter.cpp` - å®æ—¶æ»¤æ³¢å™¨å°è£…
- `include/ppg_filters.hpp` + `src/ppg_filters.cpp` - æ»¤æ³¢ç®—æ³•å®ç°

**ä¿¡å·åˆ†æï¼š**
- `include/ppg_analysis.hpp` + `src/ppg_analysis.cpp` - å¿ƒç‡ã€SpO2è®¡ç®—
- `include/find_peaks.hpp` + `src/find_peaks.cpp` - å³°å€¼æ£€æµ‹

**ç¬¬ä¸‰æ–¹åº“ï¼š**
- `DSPFilters/` - Butterworthæ»¤æ³¢å™¨å®ç°åº“ï¼ˆVinnie Falcoå¼€å‘ï¼‰

### ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  realtime_main.cpp                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ çº¢å…‰é€šé“     â”‚  â”‚ çº¢å¤–å…‰é€šé“   â”‚                     â”‚
â”‚  â”‚ filter_red  â”‚  â”‚ filter_ir    â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚         â”‚                 â”‚                              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                  â”‚                                       â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚         â”‚ RealtimeFilter  â”‚                             â”‚
â”‚         â”‚  (å°è£…å±‚)       â”‚                             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         DSPFiltersåº“ (ç¬¬ä¸‰æ–¹)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ SimpleFilter<Butterworth::BandPass<6>, 1>    â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â”‚
â”‚  â”‚  â”‚ Cascade (çº§è”ç»“æ„)                    â”‚   â”‚     â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” ...     â”‚   â”‚     â”‚
â”‚  â”‚  â”‚  â”‚Biquadâ”‚â†’â”‚Biquadâ”‚â†’â”‚Biquadâ”‚â†’ ...     â”‚   â”‚     â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â”‚
â”‚  â”‚  â”‚ ChannelsState (çŠ¶æ€ç®¡ç†)               â”‚   â”‚     â”‚
â”‚  â”‚  â”‚  DirectFormII[6] (æ¯ä¸ªBiquadçš„çŠ¶æ€)   â”‚   â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ»¤æ³¢å™¨ç±»å‹ä¸é…ç½®

### æ»¤æ³¢å™¨å‚æ•°

åœ¨ `realtime_main.cpp` ä¸­çš„é…ç½®ï¼š

```cpp
const double SAMPLE_RATE = 1000.0; // é‡‡æ ·ç‡ 1000 Hz
const double LOW_FREQ = 0.5;      // ä½é¢‘æˆªæ­¢ 0.5 Hz
const double HIGH_FREQ = 20.0;     // é«˜é¢‘æˆªæ­¢ 20 Hz
const int FILTER_ORDER = 3;       // æ»¤æ³¢å™¨é˜¶æ•° 3
```

### æ»¤æ³¢å™¨ç±»å‹ï¼šButterworth å¸¦é€šæ»¤æ³¢å™¨ï¼ˆIIRï¼‰

**ä¸ºä»€ä¹ˆé€‰æ‹© Butterworthï¼Ÿ**

1. **å¹³å¦çš„é€šå¸¦å“åº”**ï¼šåœ¨é€šå¸¦å†…å¹…åº¦å“åº”æœ€å¹³å¦ï¼Œæ— çº¹æ³¢
2. **é€‚åˆå®æ—¶å¤„ç†**ï¼šIIRæ»¤æ³¢å™¨è®¡ç®—æ•ˆç‡é«˜ï¼Œåªéœ€å½“å‰å’Œè¿‡å»çš„æ ·æœ¬
3. **å› æœæ€§**ï¼šåªéœ€è¦å†å²æ•°æ®ï¼Œé€‚åˆåµŒå…¥å¼å®æ—¶ç³»ç»Ÿ
4. **æ•°å€¼ç¨³å®š**ï¼šé€šè¿‡çº§è”äºŒé˜¶èŠ‚å®ç°ï¼Œé¿å…é«˜é˜¶å¤šé¡¹å¼çš„æ•°å€¼é—®é¢˜

### é¢‘æ®µè®¾è®¡åŸç†

**é€šå¸¦èŒƒå›´ï¼š0.5 - 20 Hz**

- **0.5 Hz ä½é¢‘æˆªæ­¢**ï¼šæ»¤é™¤å‘¼å¸ã€è¿åŠ¨ä¼ªå½±ç­‰ä½é¢‘å¹²æ‰°
- **20 Hz é«˜é¢‘æˆªæ­¢**ï¼šæ»¤é™¤å·¥é¢‘å¹²æ‰°ï¼ˆ50/60Hzï¼‰ã€é«˜é¢‘å™ªå£°
- **ç›®æ ‡ä¿¡å·**ï¼šå¿ƒç‡ä¿¡å·ï¼ˆé€šå¸¸ 0.8 - 3 Hzï¼Œå¯¹åº” 48 - 180 BPMï¼‰

**è®¡ç®—ï¼š**
- ä¸­å¿ƒé¢‘ç‡ = âˆš(0.5 Ã— 20) â‰ˆ **3.16 Hz**
- å¸¦å®½ = 20 - 0.5 = **19.5 Hz**

---

## DSPFiltersåº“å†…éƒ¨è°ƒç”¨é“¾è·¯

### å®Œæ•´è°ƒç”¨é“¾è·¯å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         realtime_main.cpp                               â”‚
â”‚                                                                         â”‚
â”‚  1. åˆ›å»ºæ»¤æ³¢å™¨å¯¹è±¡ (line 71-72)                                         â”‚
â”‚     â†“                                                                   â”‚
â”‚  ppg::RealtimeFilter filter_red(0.5, 20.0, 1000.0, 3);                â”‚
â”‚     â†“                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               src/realtime_filter.cpp (RealtimeFilteræ„é€ å‡½æ•°)          â”‚
â”‚                                                                         â”‚
â”‚  2. åˆå§‹åŒ–æˆå‘˜å˜é‡                                                      â”‚
â”‚     Dsp::SimpleFilter<Dsp::Butterworth::BandPass<6>, 1> filter_;      â”‚
â”‚     â†“                                                                   â”‚
â”‚  3. è®¡ç®—æ»¤æ³¢å™¨å‚æ•°                                                      â”‚
â”‚     center_frequency = âˆš(0.5 Ã— 20) = 3.16 Hz                          â”‚
â”‚     bandwidth = 20 - 0.5 = 19.5 Hz                                     â”‚
â”‚     â†“                                                                   â”‚
â”‚  4. è°ƒç”¨DSPFiltersåº“çš„setup                                            â”‚
â”‚     filter_.setup(3, 1000.0, 3.16, 19.5);                             â”‚
â”‚     â†“                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          DSPFilters/include/DspFilters/Filter.h                         â”‚
â”‚          SimpleFilteræ¨¡æ¿ç±» (line 243-265)                             â”‚
â”‚                                                                         â”‚
â”‚  5. SimpleFilterç»§æ‰¿è‡ªFilterClass (Butterworth::BandPass<6>)          â”‚
â”‚     template <class FilterClass, int Channels, class StateType>        â”‚
â”‚     class SimpleFilter : public FilterClass                            â”‚
â”‚     {                                                                   â”‚
â”‚         ChannelsState<Channels, FilterClass::State<StateType>> m_state;â”‚
â”‚     };                                                                  â”‚
â”‚     â†“                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       DSPFilters/source/Butterworth.cpp (BandPassBase::setup)          â”‚
â”‚       line 133-146                                                      â”‚
â”‚                                                                         â”‚
â”‚  6. è®¾è®¡æ¨¡æ‹ŸåŸå‹æ»¤æ³¢å™¨ï¼ˆSåŸŸï¼‰                                          â”‚
â”‚     m_analogProto.design(order);  // ç”ŸæˆButterworthæç‚¹              â”‚
â”‚     â†“                                                                   â”‚
â”‚  7. åŒçº¿æ€§å˜æ¢ (SåŸŸ â†’ ZåŸŸ)                                            â”‚
â”‚     BandPassTransform(centerFreq/sampleRate,                           â”‚
â”‚                      widthFreq/sampleRate,                             â”‚
â”‚                      m_digitalProto,                                   â”‚
â”‚                      m_analogProto);                                   â”‚
â”‚     â†“                                                                   â”‚
â”‚  8. è®¾ç½®çº§è”ç»“æ„                                                        â”‚
â”‚     Cascade::setLayout(m_digitalProto);                                â”‚
â”‚     â†“                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          DSPFilters/include/DspFilters/Cascade.h                        â”‚
â”‚                                                                         â”‚
â”‚  9. çº§è”ç»“æ„ (Cascade)                                                  â”‚
â”‚     - 3é˜¶Butterworthå¸¦é€š â†’ 6ä¸ªäºŒé˜¶èŠ‚ (Biquad)                        â”‚
â”‚     - æ¯ä¸ªBiquadå­˜å‚¨6ä¸ªç³»æ•°ï¼š{a0, a1, a2, b0, b1, b2}                 â”‚
â”‚                                                                         â”‚
â”‚     Stage[0]: Biquad (ç¬¬1ä¸ªäºŒé˜¶èŠ‚)                                     â”‚
â”‚     Stage[1]: Biquad (ç¬¬2ä¸ªäºŒé˜¶èŠ‚)                                     â”‚
â”‚     Stage[2]: Biquad (ç¬¬3ä¸ªäºŒé˜¶èŠ‚)                                     â”‚
â”‚     Stage[3]: Biquad (ç¬¬4ä¸ªäºŒé˜¶èŠ‚)                                     â”‚
â”‚     Stage[4]: Biquad (ç¬¬5ä¸ªäºŒé˜¶èŠ‚)                                     â”‚
â”‚     Stage[5]: Biquad (ç¬¬6ä¸ªäºŒé˜¶èŠ‚)                                     â”‚
â”‚     â†“                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®æ—¶å¤„ç†é˜¶æ®µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å®æ—¶å¤„ç†é˜¶æ®µ - é€æ ·æœ¬æ»¤æ³¢                             â”‚
â”‚                   realtime_main.cpp (line 175-176)                      â”‚
â”‚                                                                         â”‚
â”‚  10. æ¯æ¬¡è°ƒç”¨ filter_red.process_sample(raw_sample)                    â”‚
â”‚      â†“                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          src/realtime_filter.cpp::process_sample (line 33-38)           â”‚
â”‚                                                                         â”‚
â”‚  11. åŒ…è£…è°ƒç”¨DSPFiltersçš„process                                        â”‚
â”‚      float process_sample(float input)                                 â”‚
â”‚      {                                                                  â”‚
â”‚          float *p = &input;                                            â”‚
â”‚          filter_.process(1, &p);  // å¤„ç†1ä¸ªæ ·æœ¬                       â”‚
â”‚          return input;             // åŸåœ°ä¿®æ”¹                         â”‚
â”‚      }                                                                  â”‚
â”‚      â†“                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       DSPFilters/include/DspFilters/Filter.h                            â”‚
â”‚       SimpleFilter::process (line 257-260)                              â”‚
â”‚                                                                         â”‚
â”‚  12. è°ƒç”¨çŠ¶æ€å¯¹è±¡å¤„ç†                                                   â”‚
â”‚      template <typename Sample>                                        â”‚
â”‚      void process(int numSamples, Sample* const* arrayOfChannels)     â”‚
â”‚      {                                                                  â”‚
â”‚          m_state.process(numSamples, arrayOfChannels, *this);         â”‚
â”‚      }                                                                  â”‚
â”‚      â†“                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       DSPFilters/include/DspFilters/State.h                             â”‚
â”‚       ChannelsState::process (line 282-289)                             â”‚
â”‚                                                                         â”‚
â”‚  13. å¤šé€šé“å¤„ç†åˆ†å‘ (ä½ çš„ç³»ç»Ÿæ˜¯1é€šé“)                                  â”‚
â”‚      for (int i = 0; i < Channels; ++i)                               â”‚
â”‚          filter.process(numSamples, arrayOfChannels[i], m_state[i]);  â”‚
â”‚      â†“                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       DSPFilters/include/DspFilters/Cascade.h                           â”‚
â”‚       Cascade::process (line 120-127)                                   â”‚
â”‚                                                                         â”‚
â”‚  14. çº§è”æ»¤æ³¢å¤„ç†                                                       â”‚
â”‚      while (--numSamples >= 0) {                                       â”‚
â”‚          *dest = state.process(*dest, *this);                          â”‚
â”‚          dest++;                                                        â”‚
â”‚      }                                                                  â”‚
â”‚      â†“                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       DSPFilters/include/DspFilters/Cascade.h                           â”‚
â”‚       StateBase::process (line 61-74)                                   â”‚
â”‚                                                                         â”‚
â”‚  15. ä¾æ¬¡é€šè¿‡æ¯ä¸ªBiquadäºŒé˜¶èŠ‚                                          â”‚
â”‚      double out = in;                                                  â”‚
â”‚      for (int i = 0; i < numStages; ++i) {                            â”‚
â”‚          out = state[i].process1(out, stage[i], vsa);                 â”‚
â”‚      }                                                                  â”‚
â”‚      return out;                                                       â”‚
â”‚      â†“                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       DSPFilters/include/DspFilters/State.h                             â”‚
â”‚       DirectFormII::process1 (line 126-138) ã€æ ¸å¿ƒæ»¤æ³¢ç®—æ³•ã€‘          â”‚
â”‚                                                                         â”‚
â”‚  16. äºŒé˜¶IIRå·®åˆ†æ–¹ç¨‹ (æ¯ä¸ªBiquadæ‰§è¡Œä¸€æ¬¡)                             â”‚
â”‚                                                                         â”‚
â”‚      å·®åˆ†æ–¹ç¨‹ï¼ˆDirect Form IIï¼‰ï¼š                                      â”‚
â”‚                                                                         â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚      â”‚  w[n] = x[n] - a1Â·v[n-1] - a2Â·v[n-2]  â”‚  (åé¦ˆéƒ¨åˆ†)          â”‚
â”‚      â”‚  y[n] = b0Â·w[n] + b1Â·v[n-1] + b2Â·v[n-2] â”‚  (å‰é¦ˆéƒ¨åˆ†)         â”‚
â”‚      â”‚  v[n-1] â† w[n]                         â”‚  (æ›´æ–°çŠ¶æ€)          â”‚
â”‚      â”‚  v[n-2] â† v[n-1]                       â”‚                      â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                         â”‚
â”‚      template <typename Sample>                                        â”‚
â”‚      Sample process1(const Sample in,                                  â”‚
â”‚                     const BiquadBase& s,                               â”‚
â”‚                     const double vsa)                                  â”‚
â”‚      {                                                                  â”‚
â”‚          double w   = in - s.m_a1*m_v1 - s.m_a2*m_v2 + vsa;          â”‚
â”‚          double out =      s.m_b0*w    + s.m_b1*m_v1 + s.m_b2*m_v2;  â”‚
â”‚                                                                         â”‚
â”‚          m_v2 = m_v1;  // ç§»åŠ¨å†å²çŠ¶æ€                                â”‚
â”‚          m_v1 = w;                                                     â”‚
â”‚                                                                         â”‚
â”‚          return static_cast<Sample>(out);                              â”‚
â”‚      }                                                                  â”‚
â”‚                                                                         â”‚
â”‚  çŠ¶æ€å˜é‡è¯´æ˜ï¼š                                                         â”‚
â”‚  - m_v1: ä¸Šä¸€ä¸ªæ ·æœ¬çš„ä¸­é—´çŠ¶æ€ v[n-1]                                  â”‚
â”‚  - m_v2: ä¸Šä¸Šä¸ªæ ·æœ¬çš„ä¸­é—´çŠ¶æ€ v[n-2]                                  â”‚
â”‚  - vsa: very small amount (ç”¨äºé˜²æ­¢æµ®ç‚¹æ•°å»æ­£è§„åŒ–)                    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°å­¦åŸç†è¯¦è§£

### ç¬¬1å±‚ï¼šæ¨¡æ‹ŸåŸå‹è®¾è®¡ (SåŸŸ)

åœ¨ `Butterworth.cpp` çš„ `AnalogLowPass::design()` ä¸­ï¼š

```cpp
void AnalogLowPass::design (int numPoles)
{
    const double n2 = 2 * numPoles;
    const int pairs = numPoles / 2;
    for (int i = 0; i < pairs; ++i)
    {
        // åœ¨å•ä½åœ†ä¸Šå‡åŒ€åˆ†å¸ƒæç‚¹
        complex_t c = std::polar(1., Ï€/2 + (2*i + 1)*Ï€ / n2);
        addPoleZeroConjugatePairs(c, infinity());
    }
    
    if (numPoles & 1)
        add(-1, infinity());  // å¥‡æ•°é˜¶æ—¶åœ¨-1å¤„æ·»åŠ å®æç‚¹
}
```

**Butterworth 3é˜¶æç‚¹ä½ç½®ï¼š**

å¯¹äº3é˜¶æ»¤æ³¢å™¨ (numPoles = 3):
- **æç‚¹1**: e^(jÂ·150Â°) = -0.866 + j0.5
- **æç‚¹2**: e^(jÂ·180Â°) = -1.0 + j0.0  (å®æç‚¹)
- **æç‚¹3**: e^(jÂ·210Â°) = -0.866 - j0.5  (æç‚¹1çš„å…±è½­)

**Butterworthæ»¤æ³¢å™¨çš„ç‰¹ç‚¹ï¼š**
- æ‰€æœ‰æç‚¹å‡åŒ€åˆ†å¸ƒåœ¨å•ä½åœ†çš„å·¦åŠå¹³é¢
- é€šå¸¦å†…å¹…åº¦å“åº”æœ€å¹³å¦ï¼ˆæ— çº¹æ³¢ï¼‰
- è¿‡æ¸¡å¸¦è¾ƒå®½ï¼Œä½†æ•°å€¼ç¨³å®š

### ç¬¬2å±‚ï¼šå¸¦é€šå˜æ¢ (SåŸŸ â†’ SåŸŸ)

```cpp
BandPassTransform(centerFrequency / sampleRate,
                  widthFrequency / sampleRate,
                  m_digitalProto,
                  m_analogProto);
```

**å˜æ¢å…¬å¼ï¼š**

ä½é€š â†’ å¸¦é€šå˜æ¢ï¼š
```
s â†’ (sÂ² + Ï‰â‚€Â²) / (s Â· BW)
```

å…¶ä¸­ï¼š
- **Ï‰â‚€** = 2Ï€ Â· centerFrequency (ä¸­å¿ƒé¢‘ç‡)
- **BW** = 2Ï€ Â· bandwidth (å¸¦å®½)

**å˜æ¢æ•ˆæœï¼š**
- å°†**3é˜¶ä½é€š**å˜æˆ**6é˜¶å¸¦é€š**ï¼ˆé˜¶æ•°ç¿»å€ï¼‰
- æ¯ä¸ªä½é€šæç‚¹å˜æˆä¸€å¯¹å¸¦é€šæç‚¹
- ä¿æŒButterworthçš„å“åº”ç‰¹æ€§

### ç¬¬3å±‚ï¼šåŒçº¿æ€§å˜æ¢ (SåŸŸ â†’ ZåŸŸ)

**åŒçº¿æ€§å˜æ¢å…¬å¼ï¼š**

```
z = (1 + sÂ·T/2) / (1 - sÂ·T/2)

ç­‰ä»·äºï¼š
s = (2/T) Â· (z - 1) / (z + 1)
```

å…¶ä¸­ **T = 1/sampleRate = 1/1000 = 0.001ç§’**

**å˜æ¢ç‰¹ç‚¹ï¼š**
- å°†æ¨¡æ‹Ÿæ»¤æ³¢å™¨ï¼ˆSåŸŸï¼‰è½¬æ¢ä¸ºæ•°å­—æ»¤æ³¢å™¨ï¼ˆZåŸŸï¼‰
- ä¿æŒç¨³å®šæ€§ï¼ˆå·¦åŠå¹³é¢ â†’ å•ä½åœ†å†…ï¼‰
- é¢‘ç‡å“åº”ä¼šæœ‰è½»å¾®æ‰­æ›²ï¼ˆå¯é€šè¿‡é¢„æ‰­æ›²è¡¥å¿ï¼‰

**å˜æ¢åå¾—åˆ°ï¼š**
- 6ä¸ªäºŒé˜¶èŠ‚ï¼ˆBiquadï¼‰çš„ç³»æ•°
- æ¯ä¸ªBiquadæœ‰6ä¸ªç³»æ•°ï¼š{a0, a1, a2, b0, b1, b2}

### ç¬¬4å±‚ï¼šäºŒé˜¶èŠ‚ (Biquad) ç³»æ•°

**æ¯ä¸ªBiquadçš„ä¼ é€’å‡½æ•°ï¼š**

```
H(z) = (b0 + b1Â·zâ»Â¹ + b2Â·zâ»Â²) / (a0 + a1Â·zâ»Â¹ + a2Â·zâ»Â²)
```

**å½’ä¸€åŒ–å** (é™¤ä»¥a0):

```
H(z) = (b0' + b1'Â·zâ»Â¹ + b2'Â·zâ»Â²) / (1 + a1'Â·zâ»Â¹ + a2'Â·zâ»Â²)
```

å…¶ä¸­ï¼š
- b0' = b0/a0
- b1' = b1/a0
- b2' = b2/a0
- a1' = a1/a0
- a2' = a2/a0

**å¯¹åº”çš„å·®åˆ†æ–¹ç¨‹** (Direct Form II):

```
w[n] = x[n] - a1'Â·v[n-1] - a2'Â·v[n-2]
y[n] = b0'Â·w[n] + b1'Â·v[n-1] + b2'Â·v[n-2]
```

**çº§è”ä¼ é€’å‡½æ•°ï¼š**

```
H_total(z) = Hâ‚(z) Ã— Hâ‚‚(z) Ã— Hâ‚ƒ(z) Ã— Hâ‚„(z) Ã— Hâ‚…(z) Ã— Hâ‚†(z)
```

---

## å†…å­˜å¸ƒå±€ä¸çŠ¶æ€ç®¡ç†

### æ»¤æ³¢å™¨å¯¹è±¡ç»“æ„

```cpp
Dsp::SimpleFilter<Dsp::Butterworth::BandPass<6>, 1> filter_;
```

**å†…å­˜å¸ƒå±€ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SimpleFilterå¯¹è±¡                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç»§æ‰¿è‡ª: Butterworth::BandPass<6>                       â”‚
â”‚   - m_numStages = 6                                    â”‚
â”‚   - m_stageArray[6]:                                   â”‚
â”‚       â”œâ”€ Stage[0]: {a0, a1, a2, b0, b1, b2}          â”‚
â”‚       â”œâ”€ Stage[1]: {a0, a1, a2, b0, b1, b2}          â”‚
â”‚       â”œâ”€ Stage[2]: {a0, a1, a2, b0, b1, b2}          â”‚
â”‚       â”œâ”€ Stage[3]: {a0, a1, a2, b0, b1, b2}          â”‚
â”‚       â”œâ”€ Stage[4]: {a0, a1, a2, b0, b1, b2}          â”‚
â”‚       â””â”€ Stage[5]: {a0, a1, a2, b0, b1, b2}          â”‚
â”‚                                                        â”‚
â”‚ æˆå‘˜å˜é‡: m_state (ChannelsState<1, DirectFormII>)    â”‚
â”‚   - m_state[0]: {v1, v2}  // ç¬¬1ä¸ªBiquadçš„çŠ¶æ€       â”‚
â”‚   - m_state[1]: {v1, v2}  // ç¬¬2ä¸ªBiquadçš„çŠ¶æ€       â”‚
â”‚   - m_state[2]: {v1, v2}  // ç¬¬3ä¸ªBiquadçš„çŠ¶æ€       â”‚
â”‚   - m_state[3]: {v1, v2}  // ç¬¬4ä¸ªBiquadçš„çŠ¶æ€       â”‚
â”‚   - m_state[4]: {v1, v2}  // ç¬¬5ä¸ªBiquadçš„çŠ¶æ€       â”‚
â”‚   - m_state[5]: {v1, v2}  // ç¬¬6ä¸ªBiquadçš„çŠ¶æ€       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»å†…å­˜: 6ä¸ªç³»æ•°ç»„ Ã— 6ä¸ªdouble = 288å­—èŠ‚ (ç³»æ•°)
       6ä¸ªçŠ¶æ€å¯¹   Ã— 2ä¸ªdouble = 96å­—èŠ‚  (çŠ¶æ€)
       æ€»è®¡çº¦ 384å­—èŠ‚ æ¯ä¸ªæ»¤æ³¢å™¨
```

### çŠ¶æ€å˜é‡è¯´æ˜

**DirectFormII çŠ¶æ€ï¼š**

```cpp
class DirectFormII
{
private:
    double m_v1; // v[n-1] - ä¸Šä¸€ä¸ªæ ·æœ¬çš„ä¸­é—´çŠ¶æ€
    double m_v2; // v[n-2] - ä¸Šä¸Šä¸ªæ ·æœ¬çš„ä¸­é—´çŠ¶æ€
};
```

**çŠ¶æ€æ›´æ–°è¿‡ç¨‹ï¼š**

```
åˆå§‹çŠ¶æ€: v1 = 0, v2 = 0

å¤„ç†æ ·æœ¬ x[n]:
  1. w = x[n] - a1Â·v1 - a2Â·v2
  2. y[n] = b0Â·w + b1Â·v1 + b2Â·v2
  3. v2 = v1  (ç§»åŠ¨å†å²)
  4. v1 = w   (æ›´æ–°å½“å‰çŠ¶æ€)
```

**ä¸ºä»€ä¹ˆéœ€è¦çŠ¶æ€ï¼Ÿ**

IIRæ»¤æ³¢å™¨æ˜¯**é€’å½’**çš„ï¼Œè¾“å‡ºä¾èµ–äºï¼š
- å½“å‰è¾“å…¥ x[n]
- å†å²è¾“å…¥ x[n-1], x[n-2], ...
- å†å²è¾“å‡º y[n-1], y[n-2], ...

Direct Form II å°†å†å²ä¿¡æ¯å‹ç¼©åˆ°2ä¸ªçŠ¶æ€å˜é‡ä¸­ï¼ŒèŠ‚çœå†…å­˜ã€‚

---

## å®æ—¶å¤„ç†æµç¨‹

### å•æ ·æœ¬å¤„ç†çš„å®Œæ•´æµç¨‹

è®©æˆ‘ä»¬è¿½è¸ªä¸€ä¸ªæ ·æœ¬å€¼ `x = 1000` é€šè¿‡æ•´ä¸ªæ»¤æ³¢å™¨ï¼š

```
è¾“å…¥: x = 1000.0

â”Œâ”€ Stage 0 (Biquad #1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ v[n-1] = 0.123 (ä¸Šæ¬¡çš„çŠ¶æ€)           â”‚
â”‚ v[n-2] = 0.089                        â”‚
â”‚                                       â”‚
â”‚ w = 1000 - (-0.95)Ã—0.123 - 0.42Ã—0.089â”‚
â”‚   = 1000 + 0.117 - 0.037              â”‚
â”‚   = 1000.08                           â”‚
â”‚                                       â”‚
â”‚ out = 0.05Ã—1000.08 + 0.1Ã—0.123 + ...â”‚
â”‚     = 50.12                           â”‚
â”‚                                       â”‚
â”‚ æ›´æ–°çŠ¶æ€: v[n-1] â† 1000.08            â”‚
â”‚          v[n-2] â† 0.123               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“ out = 50.12

â”Œâ”€ Stage 1 (Biquad #2) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¾“å…¥: 50.12                            â”‚
â”‚ (é‡å¤ä¸Šè¿°è®¡ç®—)                         â”‚
â”‚ out = 45.67                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“ out = 45.67

â”Œâ”€ Stage 2 (Biquad #3) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¾“å…¥: 45.67                            â”‚
â”‚ out = 42.31                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“ out = 42.31

... (Stage 3, 4, 5 ç±»ä¼¼)

æœ€ç»ˆè¾“å‡º: y = 38.92
```

### æ»¤æ³¢å™¨é¢„çƒ­ï¼ˆWarmupï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦é¢„çƒ­ï¼Ÿ**

IIRæ»¤æ³¢å™¨åœ¨å¯åŠ¨æ—¶ä¼šæœ‰**ç¬æ€å“åº”**ï¼Œå‰å‡ ç™¾ä¸ªæ ·æœ¬å¯èƒ½å¤±çœŸã€‚

**é¢„çƒ­è¿‡ç¨‹ï¼š**

```cpp
void RealtimeFilter::warmup(float initial_value, int num_samples)
{
    reset();  // æ¸…é›¶æ‰€æœ‰çŠ¶æ€
    
    // ç”¨åˆå§‹å€¼ï¼ˆä¿¡å·å‡å€¼ï¼‰å–‚å…¥æ»¤æ³¢å™¨
    for (int i = 0; i < num_samples; ++i)
    {
        float temp = initial_value;
        float *p = &temp;
        filter_.process(1, &p);
    }
}
```

**é¢„çƒ­æ•ˆæœï¼š**
- ç”¨ä¿¡å·å‡å€¼åˆå§‹åŒ–æ»¤æ³¢å™¨çš„å†…éƒ¨çŠ¶æ€
- é¿å…å¯åŠ¨æ—¶çš„å¤§å¹…æŒ¯è¡
- å‡å°‘å‰å‡ ç™¾ä¸ªæ ·æœ¬çš„å¤±çœŸ

**åœ¨ä½ çš„ç³»ç»Ÿä¸­ï¼š**

```cpp
// è®¡ç®—å‰100ä¸ªæ ·æœ¬çš„å‡å€¼
float initial_mean_red = warmup_sum_red / warmup_samples_red.size();
filter_red.warmup(initial_mean_red, 100);
```

### åŒé€šé“å¤„ç†

ä½ çš„ç³»ç»ŸåŒæ—¶å¤„ç†**çº¢å…‰å’Œçº¢å¤–å…‰**ä¸¤ä¸ªé€šé“ï¼š

```cpp
// åˆ›å»ºåŒé€šé“æ»¤æ³¢å™¨
ppg::RealtimeFilter filter_red(LOW_FREQ, HIGH_FREQ, SAMPLE_RATE, FILTER_ORDER);
ppg::RealtimeFilter filter_ir(LOW_FREQ, HIGH_FREQ, SAMPLE_RATE, FILTER_ORDER);

// å®æ—¶å¤„ç†
float filtered_red = filter_red.process_sample(raw_red_float);
float filtered_ir = filter_ir.process_sample(raw_ir_float);
```

**åŒé€šé“çš„ç”¨é€”ï¼š**
- **çº¢å…‰é€šé“ (660nm)**ï¼šç”¨äºå¿ƒç‡æ£€æµ‹
- **çº¢å¤–å…‰é€šé“ (880nm)**ï¼šç”¨äº SpO2ï¼ˆè¡€æ°§é¥±å’Œåº¦ï¼‰è®¡ç®—
- **R æ¯”å€¼**ï¼šR = (çº¢å…‰AC/DC) / (çº¢å¤–å…‰AC/DC)

---

## æ€§èƒ½åˆ†æ

### æ¯æ ·æœ¬è®¡ç®—é‡

å¯¹äº3é˜¶Butterworthå¸¦é€šï¼ˆ6ä¸ªäºŒé˜¶èŠ‚ï¼‰ï¼š

**æ¯ä¸ªäºŒé˜¶èŠ‚çš„è®¡ç®—ï¼š**
- 5æ¬¡ä¹˜æ³• (a1Ã—v1, a2Ã—v2, b0Ã—w, b1Ã—v1, b2Ã—v2)
- 4æ¬¡åŠ æ³•
- 2æ¬¡èµ‹å€¼

**6ä¸ªäºŒé˜¶èŠ‚æ€»è®¡ï¼š**
- 30æ¬¡ä¹˜æ³•
- 24æ¬¡åŠ æ³•
- 12æ¬¡èµ‹å€¼

**æ€»è®¡ï¼šçº¦ 66æ¬¡æ“ä½œ / æ ·æœ¬**

### å®æ—¶æ€§èƒ½

**åœ¨1000Hzé‡‡æ ·ç‡ä¸‹ï¼š**
- 66,000 æ“ä½œ/ç§’
- å¯¹äºç°ä»£CPUï¼ˆGHzçº§åˆ«ï¼‰è½»è€Œæ˜“ä¸¾
- å¯¹äºARM Cortex-M4 @ 100MHz ä¹Ÿå®Œå…¨å¤Ÿç”¨

**å†…å­˜å ç”¨ï¼š**
- æ¯ä¸ªæ»¤æ³¢å™¨ï¼šçº¦ 384 å­—èŠ‚
- åŒé€šé“ï¼šçº¦ 768 å­—èŠ‚
- éå¸¸è½»é‡ï¼Œé€‚åˆåµŒå…¥å¼ç³»ç»Ÿ

### ä¼˜åŒ–æŠ€å·§

**1. ä½¿ç”¨int16ç¼“å†²åŒº**

```cpp
// æ»¤æ³¢åè½¬æ¢ä¸ºint16èŠ‚çœå†…å­˜
int16_t filtered_red_int = static_cast<int16_t>(std::round(filtered_red_float));
```

**ä¼˜åŠ¿ï¼š**
- int16ï¼ˆ2å­—èŠ‚ï¼‰vs floatï¼ˆ4å­—èŠ‚ï¼‰ï¼š**èŠ‚çœ50%å†…å­˜**
- å¯¹äºç¼“å†²åŒºå¤§å° 2300 æ ·æœ¬ Ã— 4 é€šé“ = èŠ‚çœçº¦ 9KB

**2. Direct Form II çš„ä¼˜åŠ¿**

ç›¸æ¯” Direct Form Iï¼š
- åªéœ€2ä¸ªçŠ¶æ€å˜é‡ (v1, v2)
- Direct Form I éœ€è¦4ä¸ª (x1, x2, y1, y2)
- **èŠ‚çœ50%çŠ¶æ€å†…å­˜**

**3. çº§è”ç»“æ„ vs ç›´æ¥å½¢å¼**

**çº§è”ç»“æ„ï¼ˆä½ çš„ç³»ç»Ÿï¼‰ï¼š**
```
H(z) = Hâ‚(z) Ã— Hâ‚‚(z) Ã— Hâ‚ƒ(z) Ã— Hâ‚„(z) Ã— Hâ‚…(z) Ã— Hâ‚†(z)
```

**ä¼˜åŠ¿ï¼š**
- æ•°å€¼ç¨³å®šæ€§æ›´å¥½
- æ¯ä¸ªäºŒé˜¶èŠ‚ç‹¬ç«‹ï¼Œç³»æ•°è¾ƒå°
- é¿å…é«˜é˜¶å¤šé¡¹å¼çš„æ•°å€¼é—®é¢˜

**å¯¹æ¯”ç›´æ¥å½¢å¼** (ä¸€ä¸ª12é˜¶æ»¤æ³¢å™¨):
```
H(z) = (b0 + b1Â·zâ»Â¹ + ... + b12Â·zâ»Â¹Â²) / (1 + a1Â·zâ»Â¹ + ... + a12Â·zâ»Â¹Â²)
```

**åŠ£åŠ¿ï¼š**
- ç³»æ•°èŒƒå›´å¤§ï¼Œå®¹æ˜“æº¢å‡º
- æ•°å€¼ä¸ç¨³å®š
- éš¾ä»¥å®ç°

---

## å…³é”®è®¾è®¡ç‰¹ç‚¹

### 1. Direct Form II çš„å®ç°

```cpp
// Direct Form II (ä½ çš„ç³»ç»Ÿä½¿ç”¨çš„)
double w   = in - s.m_a1*m_v1 - s.m_a2*m_v2;
double out =      s.m_b0*w    + s.m_b1*m_v1 + s.m_b2*m_v2;
m_v2 = m_v1;
m_v1 = w;
```

**ä¼˜åŠ¿ï¼š**
- åªéœ€2ä¸ªçŠ¶æ€å˜é‡ (v1, v2)
- Direct Form I éœ€è¦4ä¸ª (x1, x2, y1, y2)
- **èŠ‚çœ50%å†…å­˜**

### 2. å»æ­£è§„åŒ–ä¿æŠ¤ (Denormal Prevention)

```cpp
const double vsa = ac();  // very small amount â‰ˆ 1e-20
```

**ä½œç”¨ï¼š**
- é˜²æ­¢æµ®ç‚¹æ•°å˜æˆå»æ­£è§„åŒ–æ•° (denormal numbers)
- å»æ­£è§„åŒ–æ•°è¿ç®—ææ…¢ï¼ˆæ…¢10-100å€ï¼‰
- æ·»åŠ å¾®å°å¸¸æ•°ä½¿è®¡ç®—ä¿æŒåœ¨æ­£å¸¸èŒƒå›´

**å»æ­£è§„åŒ–æ•°é—®é¢˜ï¼š**
- å½“æµ®ç‚¹æ•°éå¸¸æ¥è¿‘0æ—¶ï¼Œä¼šå˜æˆå»æ­£è§„åŒ–æ•°
- å»æ­£è§„åŒ–æ•°çš„è¿ç®—é€Ÿåº¦ææ…¢
- é€šè¿‡æ·»åŠ å¾®å°å¸¸æ•°ï¼ˆvsaï¼‰é¿å…è¿™ä¸ªé—®é¢˜

### 3. çº§è”ç»“æ„çš„ä¼˜åŠ¿

**çº§è”ç»“æ„ï¼š**
```
H(z) = Hâ‚(z) Ã— Hâ‚‚(z) Ã— Hâ‚ƒ(z) Ã— Hâ‚„(z) Ã— Hâ‚…(z) Ã— Hâ‚†(z)
```

**ä¼˜åŠ¿ï¼š**
- **æ•°å€¼ç¨³å®šæ€§**ï¼šæ¯ä¸ªäºŒé˜¶èŠ‚ç‹¬ç«‹ï¼Œç³»æ•°è¾ƒå°
- **æ¨¡å—åŒ–**ï¼šæ˜“äºè°ƒè¯•å’Œä¼˜åŒ–
- **çµæ´»æ€§**ï¼šå¯ä»¥å•ç‹¬è°ƒæ•´æ¯ä¸ªäºŒé˜¶èŠ‚

**å¯¹æ¯”ç›´æ¥å½¢å¼ï¼š**
- ç³»æ•°èŒƒå›´å¤§ï¼Œå®¹æ˜“æº¢å‡º
- æ•°å€¼ä¸ç¨³å®š
- éš¾ä»¥å®ç°é«˜é˜¶æ»¤æ³¢å™¨

### 4. å®æ—¶å¤„ç†è®¾è®¡

**é€æ ·æœ¬å¤„ç†ï¼š**
```cpp
float process_sample(float input)
{
    float *p = &input;
    filter_.process(1, &p);  // å¤„ç†1ä¸ªæ ·æœ¬
    return input;
}
```

**ä¼˜åŠ¿ï¼š**
- ä½å»¶è¿Ÿï¼šæ¯ä¸ªæ ·æœ¬ç«‹å³å¤„ç†
- å†…å­˜æ•ˆç‡ï¼šä¸éœ€è¦ç¼“å†²æ•´ä¸ªä¿¡å·
- é€‚åˆå®æ—¶ç³»ç»Ÿï¼šåµŒå…¥å¼ã€å®æ—¶æ•°æ®é‡‡é›†

**å¯¹æ¯”æ‰¹é‡å¤„ç†ï¼š**
- éœ€è¦ç¼“å†²æ•´ä¸ªä¿¡å·
- å»¶è¿Ÿé«˜
- ä¸é€‚åˆå®æ—¶ç³»ç»Ÿ

---

## å®Œæ•´è°ƒç”¨æ ˆ

### åˆå§‹åŒ–é˜¶æ®µ

```
è°ƒç”¨æ ˆ (ä»ä¸Šå¾€ä¸‹)ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
realtime_main.cpp:71
    ppg::RealtimeFilter filter_red(0.5, 20.0, 1000.0, 3)
    â†“
realtime_filter.cpp:11
    RealtimeFilter::RealtimeFilter(...)
    â†“
realtime_filter.cpp:22
    filter_.setup(3, 1000.0, 3.16, 19.5)
    â†“
Butterworth.cpp:133
    BandPassBase::setup(...)
    â†“
Butterworth.cpp:49
    AnalogLowPass::design(3)  // è®¾è®¡æ¨¡æ‹ŸåŸå‹
    â†“
Butterworth.cpp:140
    BandPassTransform(...)  // å¸¦é€šå˜æ¢
    â†“
Butterworth.cpp:145
    Cascade::setLayout(...)  // è®¾ç½®çº§è”ç»“æ„
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### å®æ—¶å¤„ç†é˜¶æ®µ

```
è°ƒç”¨æ ˆ (ä»ä¸Šå¾€ä¸‹)ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
realtime_main.cpp:175
    filter_red.process_sample(1000.0f)
    â†“
realtime_filter.cpp:35
    filter_.process(1, &p)
    â†“
Filter.h:259
    m_state.process(1, arrayOfChannels, *this)
    â†“
State.h:288
    filter.process(1, arrayOfChannels[0], m_state[0])
    â†“
Cascade.h:124
    *dest = state.process(*dest, *this)
    â†“
Cascade.h:68
    out = (state++)->process1(out, *stage++, vsa)
    â†“
Biquad.h:63
    StateType::process1(in, b, ac())
    â†“
State.h:131  ã€æ ¸å¿ƒè®¡ç®—ã€‘
    w = in - s.m_a1*m_v1 - s.m_a2*m_v2 + vsa
    out = s.m_b0*w + s.m_b1*m_v1 + s.m_b2*m_v2
    m_v2 = m_v1
    m_v1 = w
    return out
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### é¢„çƒ­é˜¶æ®µ

```
è°ƒç”¨æ ˆ (ä»ä¸Šå¾€ä¸‹)ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
realtime_main.cpp:134
    filter_red.warmup(initial_mean_red, 100)
    â†“
realtime_filter.cpp:45
    RealtimeFilter::warmup(...)
    â†“
realtime_filter.cpp:50
    reset()  // æ¸…é›¶çŠ¶æ€
    â†“
Filter.h:251
    m_state.reset()
    â†“
State.h:270
    for (int i = 0; i < Channels; ++i)
        m_state[i].reset()  // æ¸…é›¶æ‰€æœ‰çŠ¶æ€
    â†“
realtime_filter.cpp:53
    filter_.process(1, &p)  // é‡å¤å¤„ç†100æ¬¡
    â†“
(åç»­è°ƒç”¨ä¸å®æ—¶å¤„ç†ç›¸åŒ)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## æ€»ç»“

### ç³»ç»Ÿç‰¹ç‚¹

1. **å®æ—¶æ€§**ï¼šé€æ ·æœ¬IIRæ»¤æ³¢ï¼Œé€‚åˆåµŒå…¥å¼ç³»ç»Ÿ
2. **å†…å­˜ä¼˜åŒ–**ï¼šä½¿ç”¨int16ç¼“å†²åŒºèŠ‚çœ50%å†…å­˜
3. **åŒé€šé“**ï¼šåŒæ—¶å¤„ç†çº¢å…‰å’Œçº¢å¤–å…‰
4. **é¢„çƒ­æœºåˆ¶**ï¼šå‡å°‘å¯åŠ¨ç¬æ€å“åº”
5. **æ»‘åŠ¨çª—å£**ï¼šç»´æŒ2.3ç§’æ•°æ®è¿›è¡Œå‘¨æœŸæ€§åˆ†æ

### æ»¤æ³¢å™¨ç‰¹ç‚¹

1. **Butterworthå¸¦é€š**ï¼šå¹³å¦é€šå¸¦å“åº”ï¼Œæ— çº¹æ³¢
2. **çº§è”ç»“æ„**ï¼š6ä¸ªäºŒé˜¶èŠ‚ï¼Œæ•°å€¼ç¨³å®š
3. **Direct Form II**ï¼šåªéœ€2ä¸ªçŠ¶æ€å˜é‡ï¼Œå†…å­˜é«˜æ•ˆ
4. **å»æ­£è§„åŒ–ä¿æŠ¤**ï¼šé¿å…æ€§èƒ½ä¸‹é™

### é€‚ç”¨åœºæ™¯

- âœ… åµŒå…¥å¼å®æ—¶ç³»ç»Ÿï¼ˆARM Cortex-Mç³»åˆ—ï¼‰
- âœ… ç”Ÿç†ä¿¡å·å¤„ç†ï¼ˆPPGã€ECGç­‰ï¼‰
- âœ… ä½å»¶è¿Ÿè¦æ±‚çš„åº”ç”¨
- âœ… å†…å­˜å—é™çš„ç¯å¢ƒ

### æ€§èƒ½æŒ‡æ ‡

- **è®¡ç®—é‡**ï¼šçº¦66æ¬¡æ“ä½œ/æ ·æœ¬
- **å†…å­˜å ç”¨**ï¼šçº¦384å­—èŠ‚/æ»¤æ³¢å™¨
- **å»¶è¿Ÿ**ï¼š1ä¸ªé‡‡æ ·å‘¨æœŸï¼ˆ1ms @ 1000Hzï¼‰
- **å®æ—¶å› å­**ï¼šå¯è½»æ¾è¾¾åˆ°å®æ—¶å¤„ç†

---

## å‚è€ƒèµ„æ–™

1. **DSPFiltersåº“**ï¼šhttps://github.com/vinniefalco/DSPFilters
2. **Butterworthæ»¤æ³¢å™¨**ï¼šæ•°å­—ä¿¡å·å¤„ç†ç»å…¸æ•™æ
3. **IIRæ»¤æ³¢å™¨è®¾è®¡**ï¼šåŒçº¿æ€§å˜æ¢ã€çº§è”ç»“æ„
4. **Direct Form II**ï¼šæ•°å­—æ»¤æ³¢å™¨å®ç°å½¢å¼

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2024å¹´  
**ä½œè€…**ï¼šAI Assistant  
**é¡¹ç›®**ï¼šPPGä¿¡å·å¤„ç†ç³»ç»Ÿ

